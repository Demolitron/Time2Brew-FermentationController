<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="css" href="./app.css">
  <link rel="stylesheet" type="css" href="./bower_components/fontawesome/css/font-awesome.min.css">
  <link rel="stylesheet" type="css" href="./bower_components/chartist/dist/chartist.min.css">
</head>

<body>
  <div class="shell">

    <div class="flex-container-col flex1">
      <div class="title flex1">
        <h1>Profiles <i class="fa fa-plus-circle icon-white" onclick="updateStatus()"></i></h1>
      </div>

      <nav class="navigator flex4">
        <button onclick="updateProfiles()">refresh profiles</button>

        <ul id="profiles">

        </ul>

      </nav>

      <div class="title flex3">
        <h3>Active Profile</h3>
        <p id="activeProfileName"></p>
        <h3>Current Step</h3>
        <p id="currentStepIndex"></p>
        <h3>Current Temperature</h3>
        <p id="currentStepTemp"></p>
        <h3>Remaining Time</h3>
        <p id="currentStepRemainingSeconds"></p>

      </div>
    </div>

    <div class="flex-container-col flex4">
      <!-- <canvas id="myChart" width="400px " height="400px "></canvas> -->

      <div class="ct-chart .ct-perfect-fourth"></div>

      <div class="flex1">
        <h3>System Time </h3>
        <p id="systemTime"></p>
        <h3>Probe 1 Temperature </h3>
        <p id="probe0Temp"></p>
        <h3>Probe 2 Temperature </h3>
        <p id="probe1Temp"></p>
        <h3>Heat Relay Status </h3>
        <p id="heatRelayStatus"></p>
        <h3>Cool Relay Status </h3>
        <p id="coolRelayStatus"></p>
        <p id="equipmentStatus">

        </p>
      </div>


    </div>
  </div>

  <script src="./promisify.js "></script>
  <script src="./chartMethods.js "></script>
  <script src="./menu.js"></script>
  <script src="./checksum.js"></script>
  <script src="./deviceAPI.js"></script>
  <script src="./equipmentProfileAPI.js"></script>
  <script src="./fermentationAPI.js"></script>
  <script src="./temperatureProfileAPI.js"></script>
  <script src="./bower_components/chartist/dist/chartist.min.js"></script>


  <script>
    function updateStatus() {
      getStatus().then(function(status) {
        document.getElementById("systemTime").innerText = status.systemTime.toString();
        document.getElementById("probe0Temp").innerText = Math.round(CelciusToFahrenheit(status.probe0Temp / 10.0) * 100) / 100;
        document.getElementById("probe1Temp").innerText = Math.round(CelciusToFahrenheit(status.probe1Temp / 10.0) * 100) / 100;
        document.getElementById("heatRelayStatus").innerText = status.heatRelayOn ? "On" : "Off";
        document.getElementById("coolRelayStatus").innerText = status.coolRelayOn ? "On" : "Off";

        document.getElementById("activeProfileName").innerText = status.activeProfileName;
        document.getElementById("currentStepIndex").innerText = status.currentStepIndex;
        document.getElementById("currentStepTemp").innerText = Math.round(CelciusToFahrenheit(status.currentStepTemp / 10.0) * 100) / 100;
        document.getElementById("currentStepRemainingSeconds").innerText = status.currentStepRemainingSeconds + "s";
      }).catch(function(error) {
        alert(error);
      });
    };

    function updateProfiles() {
      getAllProfiles()
        .then(function(profileData) {

          var profileList = document.getElementById('profiles');
          //Clear the list
          while (profileList.firstChild) {
            profileList.removeChild(profileList.firstChild);
          }

          for (var i = 0; i < profileData.length; i++) {
            var entry = document.createElement('li');
            entry.appendChild(document.createTextNode(profileData[i]));

            getProfileInstances(profileData[i])
              .then(function(instanceData) {
                var instanceList = document.createElement('ol');
                entry.appendChild(instanceList);

                for (var i = 0; i < instanceData.length; i++) {
                  var instanceEntry = document.createElement('li');
                  instanceEntry.appendChild(document.createTextNode(instanceData[i].toISOString()));
                  instanceList.appendChild(instanceEntry);
                  getTrendDataForInstance(profileData[i], instanceData[i]);
                }

              }).then(function() {
                profileList.appendChild(entry);
              });
          }
        }).catch(function(error) {
          alert(error);
        });
    };

    //instanceId is a Date
    function getTrendDataForInstance(profileName, instanceId) {


      var secondsFromEpoch = Math.round(instanceId.getTime() / 1000);

      getTrendData(profileName, secondsFromEpoch)
        .then(function(trendData) {
          // console.log(JSON.stringify(trendData));

          var probe0Temps = [];
          var probe1Temps = [];
          var setpointTemps = [];
          var outputPercentages = [];
          var labels = [];
          var seconds = 0;

          for (var i = 0; i < trendData.records.length; i++) {
            probe0Temps.push(trendData.records[i].probe0Temp);
            probe1Temps.push(trendData.records[i].probe1Temp);
            setpointTemps.push(trendData.records[i].setpointTemp);
            outputPercentages.push(trendData.records[i].outputPercent);
            instanceId.setSeconds(seconds)
            labels.push(instanceId.toISOString());
            seconds += 60;
          }

          // var datasets = [{
          //   label: "Probe 0 degF",
          //   fillColor: "rgba(220,220,220,0.2)",
          //   strokeColor: "rgba(220,220,220,1)",
          //   pointColor: "rgba(220,220,220,1)",
          //   pointStrokeColor: "#fff",
          //   pointHighlightFill: "#fff",
          //   pointHighlightStroke: "rgba(220,220,220,1)",
          //   data: probe0Temps
          // }];
          // , {
          //   label: "Probe 1 degF",
          //   fillColor: "rgba(151,187,205,0.2)",
          //   strokeColor: "rgba(151,187,205,1)",
          //   pointColor: "rgba(151,187,205,1)",
          //   pointStrokeColor: "#fff",
          //   pointHighlightFill: "#fff",
          //   pointHighlightStroke: "rgba(151,187,205,1)",
          //   data: probe1Temps
          // }, {
          //   label: "Setpoint degF",
          //   fillColor: "rgba(81,100,196,0.2)",
          //   strokeColor: "rgba(81,100,196,1)",
          //   pointColor: "rgba(81,100,196,1)",
          //   pointStrokeColor: "#fff",
          //   pointHighlightFill: "#fff",
          //   pointHighlightStroke: "rgba(81,100,196,1)",
          //   data: setPointTemps
          // }

          // var chartCanvas = document.getElementById('myChart');
          // loadChart(chartCanvas, labels, datasets);
          var data = {
            labels: labels,
            series: [probe0Temps, setpointTemps]
          };

          var options = {
            // Don't draw the line chart points
            showPoint: false,
            // Disable line smoothing
            lineSmooth: false,
            // X-Axis specific configuration
            axisX: {
              // We can disable the grid for this axis
              showGrid: false //,
                // and also don't show the label
                //showLabel: false
            },
            // Y-Axis specific configuration
            axisY: {
              // Lets offset the chart a bit from the labels
              offset: 30,
              // The label interpolation function enables you to modify the values
              // used for the labels on each axis. Here we are converting the
              // values into million pound.
              // labelInterpolationFnc: function(value) {
              //   return '$' + value + 'm';
              // }
            }
          };

          new Chartist.Line('.ct-chart', data, options);
          // loadChartist({labels: labels, series:[probe0Temps]});

        }).catch(function(error) {
          console.log(error)
        });
    }

    function onWindowLoad() {
      // updateProfiles();
      updateStatus();
    };

    window.onload = onWindowLoad();
  </script>

</body>

</html>
